import { AlgorandClient } from '@algorandfoundation/algokit-utils'
import { TransactionType } from 'algosdk'
import { describe, expect, it } from 'vitest'
import { GetSubscribedTransactions, clearUndefineds } from '../transactions'

describe('Complex transaction with many nested inner transactions', () => {
  const txnId = 'LSTIW7IBLO4SFPLFAI45WAV3NPXYPX6RWPTZ5KYDL3NX2LTJFXNA'
  const roundNumber = 34418662n
  const algorand = AlgorandClient.mainNet()

  it('Can have a keyreg transaction subscribed correctly from indexer', async () => {
    const indexerTxns = await GetSubscribedTransactions(
      {
        filters: {
          type: TransactionType.keyreg,
          sender: 'HQQRVWPYAHABKCXNMZRG242Z5GWFTJMRO63HDCLF23ZWCT3IPQXIGQ2KGY',
        },
        roundsToSync: 1,
        currentRound: roundNumber + 1n,
        syncBehaviour: 'catchup-with-indexer',
        watermark: roundNumber - 1n,
      },
      algorand,
    )

    expect(indexerTxns.subscribedTransactions.length).toBe(1)
    const txn = indexerTxns.subscribedTransactions[0]
    // https://allo.info/tx/LSTIW7IBLO4SFPLFAI45WAV3NPXYPX6RWPTZ5KYDL3NX2LTJFXNA
    expect(txn.id).toBe(txnId)
    expect(txn).toMatchInlineSnapshot(`
      {
        "applicationTransaction": undefined,
        "arc28Events": undefined,
        "assetConfigTransaction": undefined,
        "assetFreezeTransaction": undefined,
        "assetTransferTransaction": undefined,
        "authAddr": undefined,
        "balanceChanges": [
          {
            "address": "HQQRVWPYAHABKCXNMZRG242Z5GWFTJMRO63HDCLF23ZWCT3IPQXIGQ2KGY",
            "amount": -1000n,
            "assetId": 0n,
            "roles": [
              "Sender",
            ],
          },
        ],
        "closeRewards": 0n,
        "closingAmount": 0n,
        "confirmedRound": 34418662n,
        "createdApplicationIndex": undefined,
        "createdAssetIndex": undefined,
        "fee": 1000n,
        "filtersMatched": [
          "default",
        ],
        "firstValid": 34418595n,
        "genesisHash": Uint8Array [
          192,
          97,
          196,
          216,
          252,
          29,
          189,
          222,
          210,
          215,
          96,
          75,
          228,
          86,
          142,
          63,
          109,
          4,
          25,
          135,
          172,
          55,
          189,
          228,
          182,
          32,
          181,
          171,
          57,
          36,
          138,
          223,
        ],
        "genesisId": "mainnet-v1.0",
        "globalStateDelta": undefined,
        "group": undefined,
        "id": "LSTIW7IBLO4SFPLFAI45WAV3NPXYPX6RWPTZ5KYDL3NX2LTJFXNA",
        "innerTxns": undefined,
        "intraRoundOffset": 54,
        "keyregTransaction": TransactionKeyreg {
          "nonParticipation": false,
          "selectionParticipationKey": Uint8Array [
            22,
            202,
            117,
            64,
            177,
            63,
            125,
            122,
            102,
            171,
            151,
            236,
            147,
            246,
            214,
            63,
            195,
            245,
            248,
            127,
            39,
            223,
            70,
            204,
            15,
            117,
            251,
            132,
            247,
            100,
            252,
            101,
          ],
          "stateProofKey": Uint8Array [
            66,
            87,
            125,
            122,
            237,
            212,
            252,
            232,
            71,
            162,
            16,
            76,
            23,
            134,
            173,
            89,
            178,
            155,
            13,
            0,
            121,
            52,
            99,
            182,
            188,
            249,
            121,
            177,
            159,
            106,
            247,
            33,
            236,
            178,
            106,
            219,
            157,
            2,
            14,
            150,
            27,
            163,
            63,
            123,
            218,
            73,
            209,
            87,
            170,
            203,
            103,
            204,
            62,
            251,
            103,
            206,
            114,
            174,
            87,
            241,
            36,
            87,
            238,
            250,
          ],
          "voteFirstValid": 34300000n,
          "voteKeyDilution": 2450n,
          "voteLastValid": 40300000n,
          "voteParticipationKey": Uint8Array [
            201,
            68,
            126,
            157,
            241,
            237,
            73,
            189,
            173,
            192,
            230,
            169,
            172,
            69,
            235,
            157,
            136,
            228,
            133,
            177,
            76,
            6,
            217,
            151,
            91,
            208,
            252,
            199,
            239,
            209,
            56,
            24,
          ],
        },
        "lastValid": 34419595n,
        "lease": undefined,
        "localStateDelta": undefined,
        "logs": undefined,
        "note": undefined,
        "paymentTransaction": undefined,
        "receiverRewards": 0n,
        "rekeyTo": undefined,
        "roundTime": 1702579204,
        "sender": "HQQRVWPYAHABKCXNMZRG242Z5GWFTJMRO63HDCLF23ZWCT3IPQXIGQ2KGY",
        "senderRewards": 0n,
        "signature": TransactionSignature {
          "logicsig": undefined,
          "multisig": undefined,
          "sig": Uint8Array [
            206,
            207,
            188,
            31,
            146,
            120,
            133,
            121,
            166,
            42,
            77,
            250,
            184,
            75,
            169,
            130,
            234,
            68,
            228,
            88,
            165,
            195,
            252,
            76,
            105,
            237,
            40,
            199,
            151,
            59,
            202,
            225,
            204,
            226,
            54,
            21,
            60,
            179,
            193,
            96,
            114,
            206,
            116,
            246,
            169,
            130,
            228,
            156,
            63,
            59,
            179,
            208,
            185,
            222,
            203,
            255,
            149,
            244,
            193,
            107,
            40,
            184,
            253,
            15,
          ],
        },
        "stateProofTransaction": undefined,
        "txType": "keyreg",
      }
    `)
  })

  it('Can have an inner transaction subscribed correctly from algod', async () => {
    const algodTxns = await GetSubscribedTransactions(
      {
        filters: {
          type: TransactionType.keyreg,
          sender: 'HQQRVWPYAHABKCXNMZRG242Z5GWFTJMRO63HDCLF23ZWCT3IPQXIGQ2KGY',
        },
        roundsToSync: 1,
        currentRound: roundNumber + 1n,
        syncBehaviour: 'sync-oldest',
        watermark: roundNumber - 1n,
      },
      algorand,
    )

    expect(algodTxns.subscribedTransactions.length).toBe(1)
    const txn = algodTxns.subscribedTransactions[0]
    // https://allo.info/tx/LSTIW7IBLO4SFPLFAI45WAV3NPXYPX6RWPTZ5KYDL3NX2LTJFXNA
    expect(txn.id).toBe(txnId)
    expect(clearUndefineds(txn as any)).toMatchInlineSnapshot(`
      {
        "balanceChanges": [
          {
            "address": "HQQRVWPYAHABKCXNMZRG242Z5GWFTJMRO63HDCLF23ZWCT3IPQXIGQ2KGY",
            "amount": -1000n,
            "assetId": 0n,
            "roles": [
              "Sender",
            ],
          },
        ],
        "confirmedRound": 34418662n,
        "fee": 1000n,
        "filtersMatched": [
          "default",
        ],
        "firstValid": 34418595n,
        "genesisHash": {
          "data": [
            192,
            97,
            196,
            216,
            252,
            29,
            189,
            222,
            210,
            215,
            96,
            75,
            228,
            86,
            142,
            63,
            109,
            4,
            25,
            135,
            172,
            55,
            189,
            228,
            182,
            32,
            181,
            171,
            57,
            36,
            138,
            223,
          ],
          "type": "Buffer",
        },
        "genesisId": "mainnet-v1.0",
        "id": "LSTIW7IBLO4SFPLFAI45WAV3NPXYPX6RWPTZ5KYDL3NX2LTJFXNA",
        "intraRoundOffset": 54,
        "keyregTransaction": {
          "nonParticipation": false,
          "selectionParticipationKey": Uint8Array [
            22,
            202,
            117,
            64,
            177,
            63,
            125,
            122,
            102,
            171,
            151,
            236,
            147,
            246,
            214,
            63,
            195,
            245,
            248,
            127,
            39,
            223,
            70,
            204,
            15,
            117,
            251,
            132,
            247,
            100,
            252,
            101,
          ],
          "stateProofKey": Uint8Array [
            66,
            87,
            125,
            122,
            237,
            212,
            252,
            232,
            71,
            162,
            16,
            76,
            23,
            134,
            173,
            89,
            178,
            155,
            13,
            0,
            121,
            52,
            99,
            182,
            188,
            249,
            121,
            177,
            159,
            106,
            247,
            33,
            236,
            178,
            106,
            219,
            157,
            2,
            14,
            150,
            27,
            163,
            63,
            123,
            218,
            73,
            209,
            87,
            170,
            203,
            103,
            204,
            62,
            251,
            103,
            206,
            114,
            174,
            87,
            241,
            36,
            87,
            238,
            250,
          ],
          "voteFirstValid": 34300000n,
          "voteKeyDilution": 2450n,
          "voteLastValid": 40300000n,
          "voteParticipationKey": Uint8Array [
            201,
            68,
            126,
            157,
            241,
            237,
            73,
            189,
            173,
            192,
            230,
            169,
            172,
            69,
            235,
            157,
            136,
            228,
            133,
            177,
            76,
            6,
            217,
            151,
            91,
            208,
            252,
            199,
            239,
            209,
            56,
            24,
          ],
        },
        "lastValid": 34419595n,
        "note": Uint8Array [],
        "roundTime": 1702579204,
        "sender": "HQQRVWPYAHABKCXNMZRG242Z5GWFTJMRO63HDCLF23ZWCT3IPQXIGQ2KGY",
        "signature": TransactionSignature {
          "sig": Uint8Array [
            206,
            207,
            188,
            31,
            146,
            120,
            133,
            121,
            166,
            42,
            77,
            250,
            184,
            75,
            169,
            130,
            234,
            68,
            228,
            88,
            165,
            195,
            252,
            76,
            105,
            237,
            40,
            199,
            151,
            59,
            202,
            225,
            204,
            226,
            54,
            21,
            60,
            179,
            193,
            96,
            114,
            206,
            116,
            246,
            169,
            130,
            228,
            156,
            63,
            59,
            179,
            208,
            185,
            222,
            203,
            255,
            149,
            244,
            193,
            107,
            40,
            184,
            253,
            15,
          ],
        },
        "txType": "keyreg",
      }
    `)
  })
})
