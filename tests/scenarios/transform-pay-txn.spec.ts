import algosdk, { UntypedValue } from 'algosdk'
import { describe, expect, it } from 'vitest'
import { getBlockTransactions, getIndexerTransactionFromAlgodTransaction } from '../../src/transform'

describe('Payment transaction', () => {
  it('correctly handles payment lmsig logicsig signed transaction', async () => {
    const block = new algosdk.modelsv2.BlockResponse({
      block: new algosdk.Block({
        header: new algosdk.BlockHeader({
          round: 9394n,
          timestamp: 1758701734n,
          genesisID: 'dockernet-v1',
          genesisHash: new Uint8Array([
            224, 98, 0, 143, 179, 147, 51, 66, 97, 55, 93, 12, 84, 251, 18, 30, 102, 58, 226, 21, 145, 85, 241, 231, 59, 55, 213, 85, 167,
            79, 239, 157,
          ]),
          branch: new Uint8Array([
            32, 242, 130, 230, 53, 223, 251, 112, 95, 122, 187, 102, 237, 110, 23, 155, 228, 93, 86, 240, 145, 99, 119, 80, 120, 196, 65,
            235, 68, 51, 139, 155,
          ]),
          seed: new Uint8Array([
            32, 242, 130, 230, 53, 223, 251, 112, 95, 122, 187, 102, 237, 110, 23, 155, 228, 93, 86, 240, 145, 99, 119, 80, 120, 196, 65,
            235, 68, 51, 139, 155,
          ]),
          proposer: algosdk.Address.zeroAddress(),
          proposerPayout: 0n,
          feesCollected: 1000n,
          bonus: 10000000n,
          rewardState: new algosdk.RewardState({
            feeSink: new algosdk.Address(
              new Uint8Array([
                7, 218, 203, 75, 109, 158, 209, 65, 177, 117, 118, 189, 69, 154, 230, 66, 29, 72, 109, 163, 212, 239, 34, 71, 196, 9, 163,
                150, 184, 46, 162, 33,
              ]),
            ),
            rewardsPool: new algosdk.Address(
              new Uint8Array([
                255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
                255, 255, 255, 255, 255, 255, 255,
              ]),
            ),
            rewardsLevel: 0n,
            rewardsRate: 0n,
            rewardsResidue: 0n,
            rewardsRecalculationRound: 500000n,
          }),
          upgradeState: new algosdk.UpgradeState({
            currentProtocol: 'https://github.com/algorandfoundation/specs/tree/953304de35264fc3ef91bcd05c123242015eeaed',
            nextProtocol: '',
            nextProtocolApprovals: 0n,
            nextProtocolSwitchOn: 0n,
            nextProtocolVoteBefore: 0n,
          }),
          txnCommitments: new algosdk.TxnCommitments({
            nativeSha512_256Commitment: new Uint8Array([
              229, 183, 225, 191, 141, 93, 71, 223, 211, 53, 46, 40, 251, 198, 81, 216, 19, 100, 165, 70, 211, 58, 51, 182, 94, 79, 5, 163,
              161, 7, 36, 12,
            ]),
            sha256Commitment: new Uint8Array([
              19, 54, 233, 239, 227, 173, 192, 159, 154, 6, 73, 6, 53, 93, 95, 242, 223, 183, 11, 73, 98, 193, 45, 16, 130, 31, 29, 112, 37,
              213, 220, 178,
            ]),
          }),
          stateproofTracking: new Map([
            [
              0,
              new algosdk.StateProofTrackingData({
                stateProofVotersCommitment: new Uint8Array(),
                stateProofOnlineTotalWeight: 0n,
                stateProofNextRound: 8704n,
              }),
            ],
          ]),
          participationUpdates: new algosdk.ParticipationUpdates({
            expiredParticipationAccounts: [],
            absentParticipationAccounts: [],
          }),
          upgradeVote: new algosdk.UpgradeVote({
            upgradePropose: '',
            upgradeDelay: 0n,
            upgradeApprove: false,
          }),
          txnCounter: 11271n,
        }),
        payset: [
          new algosdk.SignedTxnInBlock({
            signedTxn: new algosdk.SignedTxnWithAD({
              signedTxn: new algosdk.SignedTransaction({
                lsig: (() => {
                  const lsig = new algosdk.LogicSig(new Uint8Array([1, 32, 1, 1, 34]), [new Uint8Array([1]), new Uint8Array([2, 3])])
                  lsig.lmsig = {
                    v: 1,
                    thr: 2,
                    subsig: [
                      {
                        pk: new Uint8Array([
                          27, 126, 192, 176, 75, 234, 97, 183, 150, 144, 151, 230, 203, 244, 7, 225, 8, 167, 5, 53, 29, 11, 201, 138, 190,
                          177, 34, 9, 168, 171, 129, 120,
                        ]),
                        s: new Uint8Array([
                          140, 51, 101, 196, 177, 209, 19, 112, 242, 63, 112, 215, 119, 70, 159, 225, 217, 71, 121, 191, 77, 141, 100, 129,
                          118, 73, 53, 239, 120, 76, 204, 118, 87, 108, 192, 224, 239, 233, 193, 70, 250, 96, 118, 218, 250, 206, 85, 238,
                          154, 243, 27, 118, 142, 188, 50, 180, 236, 26, 44, 140, 61, 192, 103, 6,
                        ]),
                      },
                      {
                        pk: new Uint8Array([
                          9, 99, 50, 9, 83, 115, 137, 240, 117, 103, 17, 119, 57, 145, 199, 208, 62, 27, 115, 200, 196, 245, 43, 246, 175,
                          240, 26, 162, 92, 249, 194, 113,
                        ]),
                        s: new Uint8Array([
                          79, 86, 212, 125, 217, 192, 177, 106, 21, 245, 136, 100, 233, 231, 67, 213, 49, 9, 31, 247, 175, 108, 178, 129,
                          223, 52, 13, 21, 58, 35, 110, 165, 217, 23, 115, 217, 255, 151, 101, 142, 247, 234, 99, 240, 55, 104, 205, 254,
                          40, 190, 138, 198, 130, 122, 243, 113, 173, 217, 132, 167, 56, 234, 229, 13,
                        ]),
                      },
                      {
                        pk: new Uint8Array([
                          231, 240, 248, 77, 6, 129, 29, 249, 243, 28, 141, 135, 139, 17, 85, 244, 103, 29, 81, 161, 133, 194, 0, 144, 134,
                          103, 244, 73, 88, 112, 104, 161,
                        ]),
                        s: undefined,
                      },
                    ],
                  }
                  return lsig
                })(),
                txn: new algosdk.Transaction({
                  type: algosdk.TransactionType.pay,
                  sender: new algosdk.Address(
                    new Uint8Array([
                      141, 146, 180, 137, 144, 1, 115, 160, 77, 250, 67, 89, 163, 102, 106, 106, 252, 234, 44, 66, 160, 93, 217, 193, 247,
                      62, 235, 165, 71, 128, 55, 233,
                    ]),
                  ),
                  note: new Uint8Array([180, 81, 121, 57, 252, 250, 210, 113]),
                  suggestedParams: {
                    fee: 217000n,
                    minFee: 1000,
                    firstValid: 9390,
                    lastValid: 9493,
                  },
                  paymentParams: {
                    receiver: new algosdk.Address(
                      new Uint8Array([
                        121, 236, 212, 205, 44, 7, 137, 200, 227, 55, 228, 155, 207, 65, 219, 118, 9, 113, 7, 158, 202, 35, 240, 253, 169,
                        35, 123, 31, 188, 17, 138, 178,
                      ]),
                    ),
                    amount: 1000n,
                  },
                }),
              }),
              applyData: new algosdk.ApplyData({
                applicationID: undefined,
                evalDelta: undefined,
              }),
            }),
            hasGenesisID: true,
            hasGenesisHash: false,
          }),
        ],
      }),
      cert: new UntypedValue(new Map([['rnd', 9394n]])),
    })
    const txn = getBlockTransactions(block)[0]
    const transaction = getIndexerTransactionFromAlgodTransaction(txn)

    expect(transaction.signature?.logicsig?.logicMultisigSignature).toMatchInlineSnapshot(`
      TransactionSignatureMultisig {
        "subsignature": [
          TransactionSignatureMultisigSubsignature {
            "publicKey": Uint8Array [
              27,
              126,
              192,
              176,
              75,
              234,
              97,
              183,
              150,
              144,
              151,
              230,
              203,
              244,
              7,
              225,
              8,
              167,
              5,
              53,
              29,
              11,
              201,
              138,
              190,
              177,
              34,
              9,
              168,
              171,
              129,
              120,
            ],
            "signature": Uint8Array [
              140,
              51,
              101,
              196,
              177,
              209,
              19,
              112,
              242,
              63,
              112,
              215,
              119,
              70,
              159,
              225,
              217,
              71,
              121,
              191,
              77,
              141,
              100,
              129,
              118,
              73,
              53,
              239,
              120,
              76,
              204,
              118,
              87,
              108,
              192,
              224,
              239,
              233,
              193,
              70,
              250,
              96,
              118,
              218,
              250,
              206,
              85,
              238,
              154,
              243,
              27,
              118,
              142,
              188,
              50,
              180,
              236,
              26,
              44,
              140,
              61,
              192,
              103,
              6,
            ],
          },
          TransactionSignatureMultisigSubsignature {
            "publicKey": Uint8Array [
              9,
              99,
              50,
              9,
              83,
              115,
              137,
              240,
              117,
              103,
              17,
              119,
              57,
              145,
              199,
              208,
              62,
              27,
              115,
              200,
              196,
              245,
              43,
              246,
              175,
              240,
              26,
              162,
              92,
              249,
              194,
              113,
            ],
            "signature": Uint8Array [
              79,
              86,
              212,
              125,
              217,
              192,
              177,
              106,
              21,
              245,
              136,
              100,
              233,
              231,
              67,
              213,
              49,
              9,
              31,
              247,
              175,
              108,
              178,
              129,
              223,
              52,
              13,
              21,
              58,
              35,
              110,
              165,
              217,
              23,
              115,
              217,
              255,
              151,
              101,
              142,
              247,
              234,
              99,
              240,
              55,
              104,
              205,
              254,
              40,
              190,
              138,
              198,
              130,
              122,
              243,
              113,
              173,
              217,
              132,
              167,
              56,
              234,
              229,
              13,
            ],
          },
          TransactionSignatureMultisigSubsignature {
            "publicKey": Uint8Array [
              231,
              240,
              248,
              77,
              6,
              129,
              29,
              249,
              243,
              28,
              141,
              135,
              139,
              17,
              85,
              244,
              103,
              29,
              81,
              161,
              133,
              194,
              0,
              144,
              134,
              103,
              244,
              73,
              88,
              112,
              104,
              161,
            ],
            "signature": undefined,
          },
        ],
        "threshold": 2,
        "version": 1,
      }
    `)
  })
})
